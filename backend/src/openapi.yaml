openapi: 3.0.3
info:
  title: Agrarian Deployment Dashboard API
  version: "1.0.0"
  description: |
    Base URL: http://<host>:8002
    Notes:
    - All timestamps are UTC ISO 8601 (Z / +00:00).
servers:
  - url: http://{host}:8002
    variables:
      host:
        default: localhost

tags:
  - name: Health
  - name: Deployment Management
  - name: Application Discovery
  - name: Satellite Management
  - name: Kubernetes Resources
  - name: History & Logs
  - name: Metrics
  - name: Templates
  - name: KEDA Integration
  - name: Pod Management

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/HealthResponse" }

  /api/health:
    get:
      tags: [Health]
      summary: API health check endpoint
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/HealthResponse" }

  /api/deploy:
    post:
      tags: [Deployment Management]
      summary: Deploy an application to Kubernetes
      description: Supports regular and satellite deployments (scheduled via KEDA when node="satellite").
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeployRequest" }
      responses:
        "200":
          description: Deployment result (regular or scheduled)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeployResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/generate-yaml:
    post:
      tags: [Deployment Management]
      summary: Generate Kubernetes YAML manifest (no deploy)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/DeployRequest" }
      responses:
        "200":
          description: Generated YAML/manifest object
          content:
            application/json:
              schema: { $ref: "#/components/schemas/GenerateYamlResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/deployments/detailed:
    get:
      tags: [Deployment Management]
      summary: Get detailed info about all deployments across all namespaces
      responses:
        "200":
          description: List of deployments
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/DeploymentSummary" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/deployment/{namespace}/{name}/details:
    get:
      tags: [Deployment Management]
      summary: Get detailed information about a specific deployment
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - $ref: "#/components/parameters/DeploymentNamePath"
      responses:
        "200":
          description: Deployment details
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeploymentDetails" }
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/deployment/{namespace}/{name}/scale:
    post:
      tags: [Deployment Management]
      summary: Scale a deployment to a specific number of replicas
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - $ref: "#/components/parameters/DeploymentNamePath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/ScaleRequest" }
      responses:
        "200":
          description: Scale result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ScaleResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/deployment/{namespace}/{name}:
    delete:
      tags: [Deployment Management]
      summary: Delete a deployment
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - $ref: "#/components/parameters/DeploymentNamePath"
      responses:
        "200":
          description: Delete result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SuccessMessage" }
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/apps:
    get:
      tags: [Application Discovery]
      summary: Get list of available application names from GitHub Packages
      responses:
        "200":
          description: App names
          content:
            application/json:
              schema:
                type: array
                items: { type: string }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/applications:
    get:
      tags: [Application Discovery]
      summary: Get detailed info about all available applications from GitHub Packages
      parameters:
        - name: refresh
          in: query
          required: false
          schema: { type: boolean, default: false }
          description: Force refresh from GitHub
      responses:
        "200":
          description: Applications
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Application" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/satellite/next:
    get:
      tags: [Satellite Management]
      summary: Get the next available satellite and all upcoming passes (next 24 hours)
      responses:
        "200":
          description: Next satellite and passes
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SatelliteNextResponse" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/satellite/passes:
    get:
      tags: [Satellite Management]
      summary: Get all satellite passes for the next N days
      parameters:
        - name: days_ahead
          in: query
          required: false
          schema: { type: integer, default: 1, minimum: 1 }
      responses:
        "200":
          description: Passes
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SatellitePassesResponse" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/satellite/passes/{satellite_name}:
    get:
      tags: [Satellite Management]
      summary: Get all passes for a specific satellite
      parameters:
        - name: satellite_name
          in: path
          required: true
          schema: { type: string, example: SATELIOT_4 }
        - name: days_ahead
          in: query
          required: false
          schema: { type: integer, default: 1, minimum: 1 }
      responses:
        "200":
          description: Passes for satellite
          content:
            application/json:
              schema: { $ref: "#/components/schemas/SatellitePassesForSatelliteResponse" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/namespaces:
    get:
      tags: [Kubernetes Resources]
      summary: Get list of available Kubernetes namespaces
      responses:
        "200":
          description: Namespaces
          content:
            application/json:
              schema:
                type: array
                items: { type: string }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/nodes:
    get:
      tags: [Kubernetes Resources]
      summary: Get list of available Kubernetes worker nodes
      responses:
        "200":
          description: Node names
          content:
            application/json:
              schema:
                type: array
                items: { type: string }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/history/deployments:
    get:
      tags: [History & Logs]
      summary: Get deployment history from Kubernetes
      responses:
        "200":
          description: History
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/DeploymentHistoryItem" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/logs/{namespace}/{pod_name}:
    get:
      tags: [History & Logs]
      summary: Get logs from a specific pod
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - name: pod_name
          in: path
          required: true
          schema: { type: string }
        - name: tail
          in: query
          required: false
          schema: { type: integer, default: 100, minimum: 1 }
        - name: follow
          in: query
          required: false
          schema: { type: boolean, default: false }
      responses:
        "200":
          description: Pod logs (plain text)
          content:
            text/plain:
              schema: { type: string }
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalError"

  /api/metrics/deployments:
    get:
      tags: [Metrics]
      summary: Get metrics for all deployments
      responses:
        "200":
          description: Deployment metrics
          content:
            application/json:
              schema: { $ref: "#/components/schemas/DeploymentMetrics" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/metrics/pods:
    get:
      tags: [Metrics]
      summary: Get metrics for all pods
      responses:
        "200":
          description: Pod metrics
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PodMetrics" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/templates/available:
    get:
      tags: [Templates]
      summary: Get list of available application templates
      responses:
        "200":
          description: Templates (lightweight)
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/TemplateAvailable" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/templates:
    get:
      tags: [Templates]
      summary: Get detailed template information
      parameters:
        - name: name
          in: query
          required: false
          schema: { type: string }
          description: Filter by template name
      responses:
        "200":
          description: Templates (detailed)
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/TemplateDetails" }
        "500":
          $ref: "#/components/responses/InternalError"

  /api/templates/refresh:
    post:
      tags: [Templates]
      summary: Refresh templates from GitHub Packages
      responses:
        "200":
          description: Refresh result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TemplatesRefreshResponse" }
        "500":
          $ref: "#/components/responses/InternalError"

  /keda/isActive/{namespace}/{deployment_name}:
    get:
      tags: [KEDA Integration]
      summary: Check if a deployment should be scaled (satellite pass time reached)
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - name: deployment_name
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Active result
          content:
            application/json:
              schema: { $ref: "#/components/schemas/KedaIsActiveResponse" }

  /keda/getMetricSpec/{namespace}/{deployment_name}:
    get:
      tags: [KEDA Integration]
      summary: Get metric specification for KEDA
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - name: deployment_name
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Metric spec
          content:
            application/json:
              schema: { $ref: "#/components/schemas/KedaMetricSpecResponse" }

  /keda/getMetrics/{namespace}/{deployment_name}:
    get:
      tags: [KEDA Integration]
      summary: Get current metric value for KEDA
      parameters:
        - $ref: "#/components/parameters/NamespacePath"
        - name: deployment_name
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Metrics
          content:
            application/json:
              schema: { $ref: "#/components/schemas/KedaMetricsResponse" }

  /keda/list:
    get:
      tags: [KEDA Integration]
      summary: List all registered KEDA scalers (scheduled deployments)
      responses:
        "200":
          description: Scalers
          content:
            application/json:
              schema: { $ref: "#/components/schemas/KedaListResponse" }

  /api/pods:
    get:
      tags: [Pod Management]
      summary: Get list of pods in a namespace
      parameters:
        - name: ns
          in: query
          required: false
          schema: { type: string, default: default }
      responses:
        "200":
          description: Pods
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Pod" }
        "500":
          $ref: "#/components/responses/InternalError"
    post:
      tags: [Pod Management]
      summary: Get list of pods in a namespace (POST version)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PodsPostRequest" }
      responses:
        "200":
          description: Pods (same as GET /api/pods)
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Pod" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalError"

components:
  parameters:
    NamespacePath:
      name: namespace
      in: path
      required: true
      schema: { type: string, example: default }
    DeploymentNamePath:
      name: name
      in: path
      required: true
      schema: { type: string, example: plant-app-deployment }

  responses:
    BadRequest:
      description: 400 Bad Request
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    NotFound:
      description: 404 Not Found
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    InternalError:
      description: 500 Internal Server Error
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: healthy
      required: [status]

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
      required: [detail]

    EnvVar:
      type: object
      properties:
        key: { type: string }
        value: { type: string }
      required: [key, value]

    DeployRequest:
      type: object
      required: [namespace, app]
      properties:
        namespace:
          type: string
          description: Target Kubernetes namespace
        app:
          type: string
          description: Application name (must exist in GitHub Packages)
        imageTag:
          type: string
          default: latest
        replicas:
          type: integer
          default: 1
          minimum: 1
        node:
          description: '"satellite" to auto-select next satellite; specific node name; or null / "Any node".'
          type: string
          nullable: true
          example: satellite
        env:
          type: array
          items: { $ref: "#/components/schemas/EnvVar" }

    DeployResponse:
      type: object
      properties:
        success: { type: boolean }
        deployment_id: { type: string }
        status:
          type: string
          description: success | scheduled
        message: { type: string }
        manifest:
          description: Kubernetes manifest (structure varies)
          type: object
          additionalProperties: true
        deployment_name: { type: string }
        node: { type: string }
        satellite_info:
          $ref: "#/components/schemas/SatelliteInfo"
        scheduled_time:
          type: string
          format: date-time
        delay_seconds:
          type: integer
        keda_enabled:
          type: boolean
        note:
          type: string
      required: [success, deployment_id, status, message, deployment_name]

    SatelliteInfo:
      type: object
      properties:
        satellite_name: { type: string }
        next_pass: { $ref: "#/components/schemas/SatellitePass" }
        all_passes:
          type: array
          items: { $ref: "#/components/schemas/SatellitePass" }

    GenerateYamlResponse:
      type: object
      properties:
        yaml:
          type: object
          additionalProperties: true
        success:
          type: boolean
      required: [success]

    DeploymentSummary:
      type: object
      properties:
        name: { type: string }
        namespace: { type: string }
        replicas: { type: integer }
        ready: { type: integer }
        available: { type: integer }
        age: { type: string }
        image: { type: string }
        node: { type: string }

    DeploymentDetails:
      type: object
      properties:
        name: { type: string }
        namespace: { type: string }
        replicas: { type: integer }
        ready: { type: integer }
        available: { type: integer }
        unavailable: { type: integer }
        age: { type: string }
        image: { type: string }
        node: { type: string }
        labels:
          type: object
          additionalProperties: true
        annotations:
          type: object
          additionalProperties: true

    ScaleRequest:
      type: object
      required: [replicas]
      properties:
        replicas:
          type: integer
          minimum: 0

    ScaleResponse:
      type: object
      properties:
        success: { type: boolean }
        message: { type: string }
        replicas: { type: integer }
      required: [success, message, replicas]

    SuccessMessage:
      type: object
      properties:
        success: { type: boolean }
        message: { type: string }
      required: [success, message]

    Application:
      type: object
      properties:
        name: { type: string }
        description: { type: string }
        version: { type: string }
        image: { type: string }
        tags:
          type: array
          items: { type: string }

    SatellitePass:
      type: object
      properties:
        satellite: { type: string }
        aos: { type: string, format: date-time }
        tca: { type: string, format: date-time }
        los: { type: string, format: date-time }
        duration: { type: integer }
        max_elevation: { type: number }
      required: [satellite, aos, tca, los, duration, max_elevation]

    SatelliteNextResponse:
      type: object
      properties:
        success: { type: boolean }
        satellite_name: { type: string }
        node_name: { type: string }
        next_pass: { $ref: "#/components/schemas/SatellitePass" }
        all_passes:
          type: array
          items: { $ref: "#/components/schemas/SatellitePass" }
      required: [success, satellite_name, node_name, next_pass, all_passes]

    SatellitePassesResponse:
      type: object
      properties:
        success: { type: boolean }
        passes:
          type: array
          items: { $ref: "#/components/schemas/SatellitePass" }
        count: { type: integer }
      required: [success, passes, count]

    SatellitePassesForSatelliteResponse:
      type: object
      properties:
        success: { type: boolean }
        satellite_name: { type: string }
        passes:
          type: array
          items: { $ref: "#/components/schemas/SatellitePass" }
        count: { type: integer }
      required: [success, satellite_name, passes, count]

    DeploymentHistoryItem:
      type: object
      properties:
        name: { type: string }
        namespace: { type: string }
        status: { type: string }
        replicas: { type: integer }
        age: { type: string }
        image: { type: string }

    DeploymentMetrics:
      type: object
      properties:
        total: { type: integer }
        active: { type: integer }
        failed: { type: integer }
        pending: { type: integer }
        by_namespace:
          type: object
          additionalProperties: { type: integer }
      required: [total, active, failed, pending, by_namespace]

    PodMetrics:
      type: object
      properties:
        total: { type: integer }
        running: { type: integer }
        pending: { type: integer }
        failed: { type: integer }
        by_namespace:
          type: object
          additionalProperties: { type: integer }
      required: [total, running, pending, failed, by_namespace]

    TemplateAvailable:
      type: object
      properties:
        name: { type: string }
        description: { type: string }
        image: { type: string }

    TemplateDetails:
      type: object
      properties:
        name: { type: string }
        description: { type: string }
        image: { type: string }
        defaultTag: { type: string }
        ports:
          type: array
          items: { type: integer }
        env:
          type: array
          items: { $ref: "#/components/schemas/EnvVar" }

    TemplatesRefreshResponse:
      type: object
      properties:
        success: { type: boolean }
        message: { type: string }
        count: { type: integer }
      required: [success, message, count]

    KedaIsActiveResponse:
      type: object
      properties:
        result: { type: boolean }
      required: [result]

    KedaMetricSpecResponse:
      type: object
      properties:
        metricName: { type: string }
        targetSize: { type: integer }
      required: [metricName, targetSize]

    KedaMetricsResponse:
      type: object
      properties:
        metricName: { type: string }
        metricValue: { type: integer }
      required: [metricName, metricValue]

    KedaListResponse:
      type: object
      properties:
        scalers:
          type: array
          items: { $ref: "#/components/schemas/KedaScaler" }
      required: [scalers]

    KedaScaler:
      type: object
      properties:
        namespace: { type: string }
        name: { type: string }
      required: [namespace, name]

    Pod:
      type: object
      properties:
        name: { type: string }
        namespace: { type: string }
        status: { type: string }
        node: { type: string }
        restarts: { type: integer }
        created: { type: string, format: date-time }
        age: { type: string }

    PodsPostRequest:
      type: object
      required: [ns]
      properties:
        ns: { type: string }
