openapi: 3.0.3
info:
  title: Agrarian Partner API
  description: |
    Simplified API endpoints for external collaborators to interact with the Agrarian Deployment Dashboard.
    
    This API provides a minimal set of endpoints for building simplified deployment tools without requiring
    access to the full dashboard functionality. It enables partners to:
    - Retrieve available applications with metadata
    - Query Kubernetes nodes and their associated testbeds
    - Query Kubernetes pods and their deployment information
    - Deploy applications to Kubernetes with automatic node selection
    
    ## Authentication
    Currently, this API does not require authentication. All endpoints are publicly accessible.
    
    ## Base URL
    The API is typically available at `http://10.222.0.152:8003` or `http://localhost:8003` for local development.
    
    ## Data Sources
    - **Applications**: Retrieved from GitHub Container Registry (GHCR) with metadata from `app_info.json`
    - **Nodes & Testbeds**: Retrieved from Kubernetes cluster with testbed mapping from `node_info.json`
    - **Pods**: Retrieved from Kubernetes cluster with testbed information inferred from node mappings
    
  version: 1.0.0
  contact:
    name: Agrarian Project
    url: https://github.com/agrarian-application-repository

servers:
  - url: http://10.222.0.152:8003
    description: Production server
  - url: http://localhost:8003
    description: Local development server

tags:
  - name: Applications
    description: Operations related to retrieving application information
  - name: Nodes
    description: Operations related to Kubernetes nodes and testbeds
  - name: Pods
    description: Operations related to Kubernetes pods
  - name: Deployment
    description: Operations related to deploying applications

paths:
  /api/v1/apps:
    get:
      tags:
        - Applications
      summary: Get all applications
      description: |
        Retrieves all available applications from GitHub Container Registry (GHCR) with enriched metadata
        from `app_info.json`. Each application includes information about its testbed, node type, developer,
        use case, and GitHub repository link.
        
        The endpoint combines data from:
        - GitHub Packages API (for available container images)
        - `app_info.json` (for application metadata)
      operationId: getApps
      responses:
        '200':
          description: Successful response with list of applications
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Application'
              examples:
                success:
                  summary: Example response
                  value:
                    - name: grapedisease
                      description: A set of interconnected tools for semi-automated drone-based disease detection in vineyards
                      testbed: "2"
                      node_type: Satellite
                      developer: KyberKore P.C.
                      use_case: Enables routine scanning of large vineyards to reduce manual labour
                      github_link: https://github.com/agrarian-application-repository/grapedisease/pkgs/container/grapedisease
                      image: ghcr.io/agrarian-application-repository/grapedisease
                      version: latest
                    - name: elder-app
                      description: A cost-effective, non-invasive edge-AI system that automates sheep lameness detection
                      testbed: "4"
                      node_type: Edge (Jetson Orin)
                      developer: PLAIXUS PRIVATE COMPANY (PLX)
                      use_case: Real-time lameness detection validated on a sheep farm
                      github_link: https://github.com/agrarian-application-repository/elder-app/pkgs/container/elder-app
                      image: ghcr.io/agrarian-application-repository/elder-app
                      version: latest
        '504':
          description: GitHub API request timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: GitHub API request timed out. Please try again later.
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/nodes:
    get:
      tags:
        - Nodes
      summary: Get all Kubernetes nodes with testbeds
      description: |
        Retrieves all Kubernetes nodes in the cluster along with their associated testbed information.
        The testbed information is determined from `node_info.json`, which maps each node to its
        corresponding testbed.
        
        **Node Status:**
        - `Ready`: Node is ready to accept pods
        - `NotReady`: Node is not ready (may be down, unreachable, or not fully initialized)
      operationId: getNodes
      responses:
        '200':
          description: Successful response with list of nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Node'
              examples:
                success:
                  summary: Example response
                  value:
                    - name: dlr-fog-node1
                      testbed: "2"
                      status: Ready
                    - name: demokritos-edge-node1
                      testbed: "1"
                      status: NotReady
                    - name: sateliot-edge-node1
                      testbed: "4"
                      status: Ready
        '503':
          description: Service unavailable - Cannot connect to Kubernetes cluster
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: "Cannot connect to Kubernetes cluster: No route to host"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/pods:
    get:
      tags:
        - Pods
      summary: Get all Kubernetes pods with testbed information
      description: |
        Retrieves all Kubernetes pods in the cluster (or filtered by namespace) along with their
        associated testbed information. The testbed is determined based on the node where the pod
        is running, using the mapping from `node_info.json`.
        
        **Pod Status:**
        Common statuses include: `Running`, `Pending`, `Succeeded`, `Failed`, `Unknown`
      operationId: getPods
      parameters:
        - name: namespace
          in: query
          description: Optional namespace filter. If provided, only pods in this namespace are returned.
          required: false
          schema:
            type: string
            example: default
      responses:
        '200':
          description: Successful response with list of pods
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Pod'
              examples:
                success:
                  summary: Example response
                  value:
                    - name: grapedisease-1765974975-abc123
                      status: Running
                      creation_date: "2025-01-19T10:30:00Z"
                      node: dlr-fog-node1
                      testbed: "2"
                      namespace: default
                    - name: elder-app-1765974000-xyz789
                      status: Running
                      creation_date: "2025-01-19T09:15:00Z"
                      node: sateliot-edge-node1
                      testbed: "4"
                      namespace: default
        '503':
          description: Service unavailable - Cannot connect to Kubernetes cluster
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/deploy:
    post:
      tags:
        - Deployment
      summary: Deploy an application to Kubernetes
      description: |
        Deploys an application to the Kubernetes cluster. The endpoint automatically determines the
        target node based on the application's metadata in `app_info.json` and `node_info.json`.
        
        **Automatic Node Selection:**
        1. Looks up the application in `app_info.json` to retrieve `testbed` and `node_type`
        2. Maps `node_type` to a node type in `node_info.json` (e.g., "Hybrid (Edge + Satellite)" → "fog")
        3. Finds the matching node in `node_info.json` based on `testbed` and `type`
        4. Deploys the application to that node
        
        **Node Type Mapping:**
        - "Hybrid (Edge + Satellite)" → "fog"
        - "Edge (Jetson Orin)" → "edge"
        - "Edge" → "edge"
        - "Satellite" → "satellite" (or "fog" if no satellite nodes exist)
        - "Cloud" → "cloud"
        - "Fog" → "fog"
        
        If a node is explicitly provided in the request, it will be used instead of automatic selection.
        
        The deployment creates a Kubernetes Deployment resource with the specified number of replicas.
        If the target namespace doesn't exist, it will be created automatically.
      operationId: deployApp
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
            examples:
              minimal:
                summary: Minimal request (only app name)
                value:
                  app: grapedisease
              with_namespace:
                summary: With custom namespace
                value:
                  app: grapedisease
                  namespace: production
              with_all_fields:
                summary: With all optional fields
                value:
                  app: grapedisease
                  namespace: default
                  node: dlr-fog-node1
                  replicas: 2
                  imageTag: v1.0.0
      responses:
        '200':
          description: Deployment successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
              examples:
                success:
                  summary: Successful deployment
                  value:
                    success: true
                    deployment_name: grapedisease-1765974975
                    message: Application 'grapedisease' deployed successfully to node 'dlr-fog-node1' in namespace 'default'
                    namespace: default
                    replicas: 1
                    node: dlr-fog-node1
                    app_info:
                      testbed: "Testbed 2: Non-Geosynchronous Orbit (NGSO) Satellite Communications with EDGE capabilities;"
                      node_type: Satellite
        '404':
          description: Application not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                app_not_found_github:
                  summary: App not in GitHub Packages
                  value:
                    detail: Application 'nonexistent-app' not found in GitHub Packages
                app_not_found_metadata:
                  summary: App not in app_info.json
                  value:
                    detail: Application 'grapedisease' not found in app_info.json
                node_not_found:
                  summary: Cannot determine target node
                  value:
                    detail: Could not determine target node for application 'some-app'. Please check app_info.json and node_info.json.
        '422':
          description: Validation error - Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                detail:
                  - type: missing
                    loc:
                      - body
                      - app
                    msg: Field required
                    input: null
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Service unavailable - Kubernetes client not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                detail: Kubernetes client not available

components:
  schemas:
    Application:
      type: object
      required:
        - name
        - image
        - version
      properties:
        name:
          type: string
          description: Application name (matches GitHub package name)
          example: grapedisease
        description:
          type: string
          description: Application description
          example: A set of interconnected tools for semi-automated drone-based disease detection in vineyards
        testbed:
          type: string
          description: Testbed number (extracted from full testbed name in app_info.json)
          example: "2"
        node_type:
          type: string
          description: Type of node required for this application
          example: Satellite
        developer:
          type: string
          description: Developer or organization name
          example: KyberKore P.C.
        use_case:
          type: string
          description: Use case description
          example: Enables routine scanning of large vineyards to reduce manual labour
        github_link:
          type: string
          format: uri
          description: Link to GitHub repository or package
          example: https://github.com/agrarian-application-repository/grapedisease/pkgs/container/grapedisease
        image:
          type: string
          description: Container image path
          example: ghcr.io/agrarian-application-repository/grapedisease
        version:
          type: string
          description: Image version/tag
          example: latest

    Node:
      type: object
      required:
        - name
        - testbed
        - status
      properties:
        name:
          type: string
          description: Kubernetes node name
          example: dlr-fog-node1
        testbed:
          type: string
          description: Testbed number associated with this node (from node_info.json)
          example: "2"
        status:
          type: string
          enum:
            - Ready
            - NotReady
          description: Node status in the Kubernetes cluster
          example: Ready

    Pod:
      type: object
      required:
        - name
        - status
        - creation_date
        - node
        - testbed
        - namespace
      properties:
        name:
          type: string
          description: Pod name
          example: grapedisease-1765974975-abc123
        status:
          type: string
          description: Pod status (Running, Pending, Succeeded, Failed, Unknown)
          example: Running
        creation_date:
          type: string
          format: date-time
          description: Pod creation timestamp in ISO 8601 format (UTC)
          example: "2025-01-19T10:30:00Z"
        node:
          type: string
          description: Node name where the pod is running
          example: dlr-fog-node1
        testbed:
          type: string
          description: Testbed number associated with the pod's node
          example: "2"
        namespace:
          type: string
          description: Kubernetes namespace where the pod is deployed
          example: default

    DeployRequest:
      type: object
      required:
        - app
      properties:
        app:
          type: string
          description: Application name (required). Must exist in GitHub Packages and app_info.json
          example: grapedisease
        namespace:
          type: string
          description: 'Target Kubernetes namespace (optional, default: "default")'
          default: default
          example: default
        node:
          type: string
          nullable: true
          description: Target node name (optional). If not provided, the node is automatically determined from app_info.json and node_info.json
          example: dlr-fog-node1
        replicas:
          type: integer
          minimum: 1
          description: 'Number of replicas to deploy (optional, default: 1)'
          default: 1
          example: 1
        imageTag:
          type: string
          description: 'Container image tag/version (optional, default: "latest")'
          default: latest
          example: latest

    DeployResponse:
      type: object
      required:
        - success
        - deployment_name
        - message
        - namespace
        - replicas
        - node
      properties:
        success:
          type: boolean
          description: Whether the deployment was successful
          example: true
        deployment_name:
          type: string
          description: Name of the created Kubernetes deployment
          example: grapedisease-1765974975
        message:
          type: string
          description: Human-readable status message
          example: Application 'grapedisease' deployed successfully to node 'dlr-fog-node1' in namespace 'default'
        namespace:
          type: string
          description: Namespace where the deployment was created
          example: default
        replicas:
          type: integer
          description: Number of replicas deployed
          example: 1
        node:
          type: string
          description: Node where the application was deployed
          example: dlr-fog-node1
        app_info:
          type: object
          description: Application metadata used for deployment
          properties:
            testbed:
              type: string
              description: Full testbed name from app_info.json
              example: "Testbed 2: Non-Geosynchronous Orbit (NGSO) Satellite Communications with EDGE capabilities;"
            node_type:
              type: string
              description: Node type from app_info.json
              example: Satellite

    Error:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
          example: Application 'nonexistent-app' not found in GitHub Packages

    ValidationError:
      type: object
      required:
        - detail
      properties:
        detail:
          oneOf:
            - type: string
            - type: array
              items:
                type: object
                properties:
                  type:
                    type: string
                  loc:
                    type: array
                    items:
                      oneOf:
                        - type: string
                        - type: integer
                  msg:
                    type: string
                  input:
                    type: string
                    nullable: true
          description: Validation error details
          example:
            - type: missing
              loc:
                - body
                - app
              msg: Field required
              input: null

